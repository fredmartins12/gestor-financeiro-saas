<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gest√£o Financeira</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.3s ease; }
        .modal-overlay.flex { display: flex; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 600px; }
        .action-btn { cursor: pointer; font-weight: 500; }
        .edit-btn { color: #4f46e5; } .edit-btn:hover { text-decoration: underline; }
        .delete-btn { color: #dc2626; } .delete-btn:hover { text-decoration: underline; }

        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-semibold; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards; }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(100%); } }

        .spinner { border: 2px solid rgba(0,0,0,0.1); border-top: 2px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        .spinner.mx-auto { border-top-color: #fff; width: 16px; height: 16px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .operation-body { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, opacity 0.2s ease-out; opacity: 0; visibility: hidden; }
        .is-expanded .operation-body { max-height: 2000px; opacity: 1; visibility: visible; transition: max-height 0.5s ease-in, opacity 0.3s 0.1s ease-in; }
        .toggle-icon { transition: transform 0.3s ease; }
        .is-expanded .toggle-icon { transform: rotate(180deg); }

        .tab-btn { padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid transparent; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { background-color: #4f46e5; color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab-btn:not(.active) { background-color: #e5e7eb; color: #4b5563; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Estilos para os bot√µes e tags na lista de contas */
        .status-tag { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.25rem; }
        .tag-deposit { background-color: #fef9c3; color: #ca8a04; border: 1px solid #fde047; }
        .tag-paid { color: #166534; }
        .tag-due { color: #b45309; }
        .tag-overdue { color: #991b1b; }
        .pay-btn { cursor: pointer; color: #4f46e5; font-weight: 500; margin-left: 8px; }
        .pay-btn:hover { text-decoration: underline; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-6 md:p-8">

    <div id="toast-container"></div>

    <!-- Modal para Cadastro/Edi√ß√£o de Contas -->
    <div id="account-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md">
            <h3 id="modal-title" class="text-xl font-bold mb-6">Cadastrar Nova Conta</h3>
            <form id="account-form" class="space-y-4 text-left">
                <input type="hidden" id="account-id" name="account-id">
                <div><label for="account-name" class="block text-sm font-medium text-gray-700">Nome</label><input type="text" id="account-name" name="account-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div>
                
                <div>
                    <label for="account-provider" class="block text-sm font-medium text-gray-700">Casa de Aposta</label>
                    <select id="account-provider" name="account-provider" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        <option value="">Selecione...</option>
                        <option value="bet365">Bet365</option>
                        <option value="betesporte">BetEsporte</option>
                        <option value="betano">Betano</option>
                        <option value="sportingbet">Sportingbet</option>
                        <option value="pessoal">Pessoal (Conta n√£o relacionada a apostas)</option>
                    </select>
                </div>

                <div><label for="account-balance" class="block text-sm font-medium text-gray-700">Saldo (R$)</label><input type="number" id="account-balance" name="account-balance" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                <div><label for="account-freebet-balance" class="block text-sm font-medium text-gray-700">Saldo de Freebets (R$)</label><input type="number" id="account-freebet-balance" name="account-freebet-balance" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="account-payment-day" class="block text-sm font-medium text-gray-700">Dia do Pgto. (1-31)</label><input type="number" id="account-payment-day" name="account-payment-day" min="1" max="31" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                    <div><label for="account-payment-value" class="block text-sm font-medium text-gray-700">Valor do Pgto. (R$)</label><input type="number" id="account-payment-value" name="account-payment-value" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                </div>
                <div><label for="account-goal" class="block text-sm font-medium text-gray-700">Meta do Clube (R$)</label><input type="number" id="account-goal" name="account-goal" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="100"></div>
                <div><label for="account-club-volume" class="block text-sm font-medium text-gray-700">Volume V√°lido (Inicial)</label><input type="number" id="account-club-volume" name="account-club-volume" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                <div><label for="account-last-code-date" class="block text-sm font-medium text-gray-700">Data do √öltimo C√≥digo</label><input type="date" id="account-last-code-date" name="account-last-code-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                <div><label for="account-obs" class="block text-sm font-medium text-gray-700">Observa√ß√µes</label><textarea id="account-obs" name="account-obs" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea></div>
                <div class="pt-4 flex justify-end gap-4"><button type="button" class="cancel-modal-btn bg-gray-200 text-gray-800 py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-md w-24 flex justify-center">Salvar</button></div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Lan√ßamento Externo -->
    <div id="transaction-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md">
            <h3 class="text-xl font-bold mb-6">Lan√ßamento Externo</h3>
            <form id="transaction-form" class="space-y-4 text-left">
                <div><label for="transaction-account" class="block text-sm font-medium text-gray-700">Conta</label><select id="transaction-account" name="transaction-account" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select></div>
                <div><label for="transaction-type" class="block text-sm font-medium text-gray-700">Tipo</label><select id="transaction-type" name="transaction-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required><option value="deposit">Dep√≥sito Externo (Cr√©dito)</option><option value="withdrawal">Saque Externo (D√©bito)</option><option value="payment">Pagamento (D√©bito)</option><option value="bonus">B√¥nus (Cr√©dito)</option><option value="other_debit">Outro D√©bito</option><option value="other_credit">Outro Cr√©dito</option></select></div>
                <div><label for="transaction-amount" class="block text-sm font-medium text-gray-700">Valor (R$)</label><input type="number" step="0.01" id="transaction-amount" name="transaction-amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div>
                <div><label for="transaction-description" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label><input type="text" id="transaction-description" name="transaction-description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div>
                <div class="pt-4 flex justify-end gap-4"><button type="button" class="cancel-modal-btn bg-gray-200 text-gray-800 py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-md w-28 flex justify-center">Salvar</button></div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Transfer√™ncia -->
    <div id="transfer-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md">
            <h3 class="text-xl font-bold mb-6">Transfer√™ncia Entre Contas</h3>
            <form id="transfer-form" class="space-y-4 text-left">
                <div><label for="transfer-from" class="block text-sm font-medium text-gray-700">Conta de Origem</label><select id="transfer-from" name="transfer-from" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select></div>
                <div><label for="transfer-to" class="block text-sm font-medium text-gray-700">Conta de Destino</label><select id="transfer-to" name="transfer-to" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select></div>
                <div><label for="transfer-amount" class="block text-sm font-medium text-gray-700">Valor (R$)</label><input type="number" step="0.01" id="transfer-amount" name="transfer-amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div>
                <div><label for="transfer-description" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label><input type="text" id="transfer-description" name="transfer-description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                <div class="pt-4 flex justify-end gap-4"><button type="button" class="cancel-modal-btn bg-gray-200 text-gray-800 py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-md w-32 flex justify-center">Iniciar Transfer√™ncia</button></div>
            </form>
        </div>
    </div>

    <!-- Modal para Relat√≥rios -->
    <div id="report-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Dashboard de Relat√≥rios</h3>
                <div class="flex items-center gap-2">
                    <label for="report-month" class="text-sm font-medium">Per√≠odo:</label>
                    <select id="report-month" class="rounded-md border-gray-300 shadow-sm"></select>
                    <select id="report-year" class="rounded-md border-gray-300 shadow-sm"></select>
                </div>
            </div>
            <div id="report-content" class="max-h-[70vh] overflow-y-auto bg-gray-50 p-4 rounded-lg">
                </div>
            <div class="pt-4 mt-4 border-t flex justify-end">
                <button type="button" class="cancel-modal-btn bg-gray-200 text-gray-800 py-2 px-4 rounded-md">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Gastos Pessoais -->
    <div id="expense-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md">
            <h3 class="text-xl font-bold mb-6">Registrar Gasto Pessoal</h3>
            <form id="expense-form" class="space-y-4 text-left">
                <div>
                    <label for="expense-account" class="block text-sm font-medium text-gray-700">Conta de Origem (Caixa)</label>
                    <select id="expense-account" name="expense-account" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select>
                </div>
                <div>
                    <label for="expense-amount" class="block text-sm font-medium text-gray-700">Valor do Gasto (R$)</label>
                    <input type="number" step="0.01" id="expense-amount" name="expense-amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="expense-description" class="block text-sm font-medium text-gray-700">Descri√ß√£o / Categoria</label>
                    <input type="text" id="expense-description" name="expense-description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Ex: Conta de Luz, Supermercado" required>
                </div>
                <div class="pt-4 flex justify-end gap-4">
                    <button type="button" class="cancel-modal-btn bg-gray-200 text-gray-800 py-2 px-4 rounded-md">Cancelar</button>
                    <button type="submit" class="bg-rose-600 text-white py-2 px-4 rounded-md w-28 flex justify-center">Registrar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Conte√∫do Principal -->
    <div class="max-w-screen-xl mx-auto">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold text-gray-900">Painel de Gest√£o Financeira</h1>
                <p class="text-gray-600 mt-1">Controle suas contas, opera√ß√µes e finan√ßas em um s√≥ lugar.</p>
            </div>
            <a href="/logout" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 font-semibold">Sair</a>
        </header>

        <div class="mb-10">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                <h2 class="text-2xl font-bold text-gray-800">Painel de Contas</h2>
                <div class="flex gap-4 flex-wrap">
                    <button id="report-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 font-semibold">Relat√≥rios</button>
                    <button id="transfer-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 font-semibold">Transfer√™ncia</button>
                    <button id="add-expense-btn" class="bg-rose-600 text-white py-2 px-4 rounded-md hover:bg-rose-700 font-semibold">Registrar Gasto</button>
                    <button id="add-transaction-btn" class="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 font-semibold">Lan√ßamento Externo</button>
                    <button id="add-account-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-semibold">+ Nova Conta</button>
                </div>
            </div>

            <div class="mb-4 flex items-center gap-2 flex-wrap" id="main-tabs-container">
                <button class="tab-btn active" data-tab="bet365">Bet365</button>
                <button class="tab-btn" data-tab="betesporte">BetEsporte</button>
                <button class="tab-btn" data-tab="betano">Betano</button>
                <button class="tab-btn" data-tab="sportingbet">Sportingbet</button>
                <button class="tab-btn" data-tab="personal">Contas Pessoais</button>
            </div>

            <!-- Tabelas para cada provedor -->
            <div id="tab-content-bet365" class="tab-content active">
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr class="betting-accounts-header">
                                    <th class="px-6 py-3">Status</th>
                                    <th class="px-6 py-3 cursor-pointer" data-sort="nome">Nome <span></span></th>
                                    <th class="px-6 py-3 cursor-pointer" data-sort="saldo">Saldo (R$) <span></span></th>
                                    <th class="px-6 py-3 cursor-pointer" data-sort="saldoFreebets">Freebets (R$) <span></span></th>
                                    <th class="px-6 py-3">Clube (Progresso)</th>
                                    <th class="px-6 py-3 cursor-pointer" data-sort="proxPgto">Pr√≥ximo Pgto. <span></span></th>
                                    <th class="px-6 py-3">Observa√ß√µes</th>
                                    <th class="px-6 py-3">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody class="accounts-table-body" id="bet365-accounts-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Outras tabelas (betesporte, betano, sportingbet, personal) -->
            <!-- Estrutura similar para cada provedor -->
            <div id="tab-content-betesporte" class="tab-content">
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr class="betting-accounts-header">
                                    <th class="px-6 py-3">Status</th>
                                    <th class="px-6 py-3 cursor-pointer" data-sort="nome">Nome <span></span></th>
                                    <th class="px-6 py-3 cursor-pointer" data-sort="saldo">Saldo (R$) <span></span></th>
                                    <th class="px-6 py-3 cursor-pointer" data-sort="saldoFreebets">Freebets (R$) <span></span></th>
                                    <th class="px-6 py-3">Clube (Progresso)</th>
                                    <th class="px-6 py-3 cursor-pointer" data-sort="proxPgto">Pr√≥ximo Pgto. <span></span></th>
                                    <th class="px-6 py-3">Observa√ß√µes</th>
                                    <th class="px-6 py-3">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody class="accounts-table-body" id="betesporte-accounts-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Repetir para betano, sportingbet e personal -->
            <!-- ... -->

        </div>

        <!-- Resumo Financeiro -->
        <div class="mb-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Resumo Financeiro</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                <div class="bg-white shadow-md rounded-lg p-4"><h4 class="text-sm font-semibold text-gray-500">SALDO CONTAS PESSOAIS</h4><p id="personal-balance" class="text-2xl font-bold text-indigo-600">R$ 0,00</p></div>
                <div class="bg-white shadow-md rounded-lg p-4"><h4 class="text-sm font-semibold text-gray-500">SALDO CASAS DE APOSTA</h4><p id="betting-houses-balance" class="text-2xl font-bold text-blue-600">R$ 0,00</p></div>
                <div class="bg-white shadow-md rounded-lg p-4"><h4 class="text-sm font-semibold text-gray-500">TOTAL EM FREEBETS</h4><p id="total-freebets-balance" class="text-2xl font-bold text-purple-600">R$ 0,00</p></div>
                <div class="bg-white shadow-md rounded-lg p-4"><h4 class="text-sm font-semibold text-gray-500">SALDO TOTAL GERAL</h4><p id="total-balance" class="text-2xl font-bold text-gray-800">R$ 0,00</p></div>
                <div class="bg-white shadow-md rounded-lg p-4"><h4 class="text-sm font-semibold text-gray-500">ENTRADAS (M√äS)</h4><p id="monthly-credits" class="text-2xl font-bold text-green-600">R$ 0,00</p></div>
                <div class="bg-white shadow-md rounded-lg p-4"><h4 class="text-sm font-semibold text-gray-500">SA√çDAS (M√äS)</h4><p id="monthly-debits" class="text-2xl font-bold text-red-600">R$ 0,00</p></div>
                <div class="bg-white shadow-md rounded-lg p-4 col-span-1 md:col-span-2 lg:col-span-2"><h4 class="text-sm font-semibold text-gray-500">LUCRO / PREJU√çZO (M√äS)</h4><p id="monthly-net" class="text-2xl font-bold text-gray-800">R$ 0,00</p></div>
            </div>
        </div>

        <!-- Opera√ß√µes Ativas -->
        <div class="mb-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Opera√ß√µes Ativas</h2>
            <div id="active-operations-container" class="space-y-4"></div>
        </div>

        <!-- Registro de Opera√ß√µes -->
        <div class="mb-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Registrar Opera√ß√£o de Aposta</h2>
            <div class="bg-white shadow-md rounded-lg p-6">
                <form id="operation-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 border-b pb-6">
                        <div><label for="operation-game-name" class="block text-sm font-medium text-gray-700">Jogo/Evento Principal</label><input type="text" id="operation-game-name" name="operation-game-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Ex: Palmeiras vs. Flamengo" required></div>
                        <div><label for="operation-category" class="block text-sm font-medium text-gray-700">Categoria</label><select id="operation-category" name="operation-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="esportiva">Aposta Esportiva</option><option value="surebet">Surebet / Arbitragem</option><option value="processo_freebet">PROCESSO PARA ADQUIRIR FREEBET</option><option value="extracao_freebet">Extra√ß√£o de Freebet</option><option value="extracao_moedas">Extra√ß√£o de Moedas</option><option value="cassino">Cassino (Lan√ß. Imediato)</option><option value="outro">Outro</option></select></div>
                    </div>
                    
                    <div id="multi-bet-container">
                        <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                            <h3 class="text-lg font-semibold text-gray-900">Pernas da Opera√ß√£o</h3>
                        </div>
                        <div id="legs-container" class="space-y-6"></div>
                        <div class="mt-6">
                            <button type="button" id="add-leg-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 font-semibold">+ Adicionar Perna (Novo Resultado)</button>
                        </div>
                    </div>

                    <div id="cassino-container" class="hidden">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Lan√ßamento de Cassino</h3>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-medium text-gray-700">Conta</label><select id="cassino-account" name="cassino-account" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Valor Investido (R$)</label><input type="number" step="0.01" id="cassino-stake" name="cassino-stake" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div>
                                <div><label class="block text-sm font-medium text-gray-700">Retorno Obtido (R$)</label><input type="number" step="0.01" id="cassino-return" name="cassino-return" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 border-t pt-6"><button type="submit" class="w-full bg-indigo-600 text-white py-2 px-6 rounded-md hover:bg-indigo-700 font-bold text-lg flex items-center justify-center">Registrar Opera√ß√£o</button></div>
                </form>
            </div>
        </div>
        
        <!-- Hist√≥rico de Transa√ß√µes -->
        <div class="mb-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Hist√≥rico de Transa√ß√µes Recentes</h2>
            <div class="bg-white shadow-md rounded-lg overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Data</th><th class="px-6 py-3">Conta</th><th class="px-6 py-3">Descri√ß√£o</th><th class="px-6 py-3">Tipo</th><th class="px-6 py-3">Valor (R$)</th><th class="px-6 py-3">A√ß√£o</th></tr></thead><tbody id="transactions-history-body"></tbody></table></div></div>
        </div>

        <!-- Ferramentas de Dados -->
        <div class="mb-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Ferramentas de Dados</h2>
            <div class="bg-white shadow-md rounded-lg p-6"><div class="grid grid-cols-1 md:grid-cols-3 gap-8"><div class="border-r pr-8"><h3 class="text-lg font-semibold text-gray-900 mb-2">Fazer Backup</h3><p class="text-sm text-gray-600 mb-4">Baixe um arquivo (.json) com todos os seus dados.</p><button id="backup-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 font-semibold flex items-center justify-center w-36">Baixar Backup</button></div><div class="border-r pr-8"><h3 class="text-lg font-semibold text-gray-900 mb-2">Restaurar Backup</h3><p class="text-sm text-gray-600 mb-4"><strong class="text-red-600">Aten√ß√£o:</strong> Ir√° apagar todos os dados atuais.</p><input type="file" id="restore-file-input" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/><button id="restore-btn" class="mt-4 bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 font-semibold disabled:bg-gray-400 w-36 flex justify-center" disabled>Restaurar Dados</button></div><div><h3 class="text-lg font-semibold text-gray-900 mb-2">Importar Contas via CSV</h3><p class="text-sm text-gray-600 mb-4">Crie ou atualize m√∫ltiplas contas de uma planilha. <button id="download-template-btn" class="text-blue-600 hover:underline">Baixe o modelo</button>.</p><input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"/><button id="import-csv-btn" class="mt-4 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 font-semibold disabled:bg-green-400 w-36 flex justify-center" disabled>Importar CSV</button></div></div></div>
        </div>

    </div>

    <script>
        // JavaScript para integrar com o backend Flask
        document.addEventListener('DOMContentLoaded', () => {
            // Estado global da aplica√ß√£o
            let allAccounts = [];
            let activeOperations = [];
            let transactionHistory = [];

            // Seletores de elementos do DOM
            const modals = {
                account: setupModal(document.getElementById('account-modal')),
                transaction: setupModal(document.getElementById('transaction-modal')),
                expense: setupModal(document.getElementById('expense-modal')),
                transfer: setupModal(document.getElementById('transfer-modal')),
                report: setupModal(document.getElementById('report-modal'))
            };
            
            const addAccountBtn = document.getElementById('add-account-btn');
            const addTransactionBtn = document.getElementById('add-transaction-btn');
            const addExpenseBtn = document.getElementById('add-expense-btn');
            const transferBtn = document.getElementById('transfer-btn');
            const reportBtn = document.getElementById('report-btn');
            const backupBtn = document.getElementById('backup-btn');
            
            const accountForm = document.getElementById('account-form');
            const transactionForm = document.getElementById('transaction-form');
            const expenseForm = document.getElementById('expense-form');
            const transferForm = document.getElementById('transfer-form');
            const operationForm = document.getElementById('operation-form');
            
            const operationCategorySelect = document.getElementById('operation-category');
            const legsContainer = document.getElementById('legs-container');
            const addLegBtn = document.getElementById('add-leg-btn');
            
            const activeOperationsContainer = document.getElementById('active-operations-container');
            const mainTabsContainer = document.getElementById('main-tabs-container');
            const mainContainer = document.querySelector('.max-w-screen-xl');

            // Fun√ß√µes de API
            async function apiRequest(endpoint, method = 'GET', body = null) {
                const options = { method, headers: { 'Content-Type': 'application/json' } };
                if (body) options.body = JSON.stringify(body);
                
                const response = await fetch(endpoint, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    return response.json();
                } else {
                    return { message: 'Success' };
                }
            }

            // Fun√ß√µes de UI e utilit√°rios
            const formatCurrency = (value) => `R$ ${(typeof value === 'number' ? value : 0).toFixed(2).replace('.', ',')}`;
            
            const floorToTwoDecimals = (num) => {
                const numAsFloat = parseFloat(num);
                if (isNaN(numAsFloat)) return 0;
                return Math.floor(numAsFloat * 100) / 100;
            };
            
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
            }
            
            function setupModal(modalElement) {
                const controller = {
                    element: modalElement,
                    open: () => modalElement.classList.add('flex'),
                    close: () => modalElement.classList.remove('flex'),
                };
                
                modalElement.addEventListener('click', (e) => {
                    if (e.target === modalElement || e.target.closest('.cancel-modal-btn')) controller.close();
                });
                
                return controller;
            }

            // Renderiza√ß√£o
            function renderTables() {
                const providers = ['bet365', 'betesporte', 'betano', 'sportingbet', 'pessoal'];
                providers.forEach(provider => {
                    const tableBodyId = provider === 'pessoal' ? 'personal-accounts-body' : `${provider}-accounts-body`;
                    const tableBody = document.getElementById(tableBodyId);
                    if (!tableBody) return;
                    
                    const filteredAccounts = allAccounts.filter(acc => acc.casa_de_aposta === provider);
                    tableBody.innerHTML = filteredAccounts.length === 0
                        ? `<tr><td colspan="8" class="text-center p-4">Nenhuma conta encontrada.</td></tr>`
                        : filteredAccounts.map(acc => {
                            let statusHtml = '';
                            if (acc.saldo < 150 && provider !== 'pessoal') {
                                statusHtml = `<span class="status-tag tag-deposit">üí∞ Dep√≥sito</span>`;
                            }
                            
                            if (acc.data_ultimo_codigo) {
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);
                                const lastCodeDate = new Date(acc.data_ultimo_codigo + 'T00:00:00');
                                const diffTime = today - lastCodeDate;
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                
                                if (diffDays === 6) {
                                    statusHtml += `<span class="ml-2" title="A conta '${acc.nome}' precisar√° de c√≥digo amanh√£!">‚ö†Ô∏è</span>`;
                                } else if (diffDays >= 7) {
                                    statusHtml += `<span class="ml-2" title="A conta '${acc.nome}' precisa de um novo c√≥digo!">üö®</span>`;
                                }
                            }

                            let paymentHtml = 'N/A';
                            if (acc.dia_pagamento && provider !== 'pessoal') {
                                const today = new Date();
                                const currentYear = today.getFullYear();
                                const currentMonth = today.getMonth();
                                const currentPeriod = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                                const dueDateThisMonth = new Date(currentYear, currentMonth, acc.dia_pagamento);
                                
                                if (acc.ultimo_periodo_pago === currentPeriod) {
                                    const nextDueDate = new Date(currentYear, currentMonth + 1, acc.dia_pagamento);
                                    const nextDateStr = `${String(nextDueDate.getDate()).padStart(2, '0')}/${String(nextDueDate.getMonth() + 1).padStart(2, '0')}`;
                                    paymentHtml = `<span class="tag-paid">Pago ‚úî (Pr√≥ximo: ${nextDateStr})</span>`;
                                } else {
                                    const diffTime = dueDateThisMonth.getTime() - today.getTime();
                                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                    const dueDateStr = `${String(dueDateThisMonth.getDate()).padStart(2, '0')}/${String(dueDateThisMonth.getMonth() + 1).padStart(2, '0')}`;
                                    
                                    if (diffDays < 0) {
                                        paymentHtml = `<span class="tag-overdue">${dueDateStr} (Vencido h√° ${Math.abs(diffDays)} dias)</span>`;
                                    } else {
                                        paymentHtml = `<span class="tag-due">${dueDateStr} (Vence em ${diffDays} dias)</span>`;
                                    }
                                    paymentHtml += `<span class="pay-btn" data-account-id="${acc.id}" data-account-name="${acc.nome}">Pagar</span>`;
                                }
                            }

                            return `
                                <tr class="bg-white border-b hover:bg-gray-50" data-account-id="${acc.id}">
                                    ${provider !== 'pessoal' ? `<td class="px-6 py-4">${statusHtml}</td>` : ''}
                                    <td class="px-6 py-4 font-medium text-gray-900">${acc.nome}</td>
                                    <td class="px-6 py-4 font-bold">${formatCurrency(acc.saldo)}</td>
                                    <td class="px-6 py-4 font-medium text-blue-600">${formatCurrency(acc.saldo_freebets)}</td>
                                    ${provider !== 'pessoal' ? `<td class="px-6 py-4">${formatCurrency(acc.volume_clube)}</td>` : ''}
                                    <td class="px-6 py-4 text-sm">${paymentHtml}</td>
                                    <td class="px-6 py-4">${acc.observacoes || ''}</td>
                                    <td class="px-6 py-4 flex flex-wrap gap-x-4 gap-y-2 items-center">
                                        <span class="action-btn edit-btn">Editar</span>
                                        <span class="action-btn delete-btn">Excluir</span>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                });
            }
            
            function renderActiveOperations() {
                if (activeOperations.length === 0) {
                    activeOperationsContainer.innerHTML = `<p class="text-gray-500 bg-white shadow-md rounded-lg p-6">Nenhuma opera√ß√£o ativa no momento.</p>`;
                    return;
                }
                
                const opsById = activeOperations.reduce((acc, bet) => {
                    const details = JSON.parse(bet.detalhes);
                    const opId = details.operationId;
                    if (!acc[opId]) {
                        acc[opId] = {
                            gameName: bet.descricao.split(' - ')[0],
                            bets: []
                        };
                    }
                    acc[opId].bets.push({ ...bet, detalhes: details });
                    return acc;
                }, {});
                
                activeOperationsContainer.innerHTML = Object.entries(opsById).map(([opId, op]) => {
                    const marketsHtml = op.bets.map(bet => `
                        <div class="border-t py-3">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="winner_${opId}" value="${bet.detalhes.result}" class="market-winner-radio h-5 w-5 rounded-full border-gray-300 text-indigo-600">
                                <span class="font-semibold text-gray-800">${bet.detalhes.result} (@${parseFloat(bet.detalhes.odd).toFixed(5)})</span>
                            </label>
                            <p class="pl-8 text-sm text-gray-600">${bet.nome_conta} - ${formatCurrency(bet.detalhes.stake)}</p>
                        </div>`).join('');
                    
                    const lostHtml = `
                        <div class="border-t py-3">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" class="lost-operation-checkbox h-5 w-5 rounded border-gray-300 text-red-600">
                                <span class="font-semibold text-red-700">Nenhum Vencedor (Opera√ß√£o Perdida)</span>
                            </label>
                        </div>`;
                    
                    return `
                        <div class="bg-white shadow-md rounded-lg operation-card" data-op-id="${opId}">
                            <div class="operation-header flex justify-between items-center p-4 cursor-pointer toggle-details-btn">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">${op.gameName}</h3>
                                    <p class="text-xs text-gray-500 capitalize font-semibold">${op.bets[0].detalhes.category}</p>
                                </div>
                                <span class="toggle-icon text-gray-500 font-bold text-xl">‚ñº</span>
                            </div>
                            <div class="operation-body border-t px-4">
                                <div class="py-4">
                                    ${marketsHtml}
                                    ${lostHtml}
                                    <div class="mt-4 border-t pt-4 text-right">
                                        <button class="resolve-operation-btn bg-green-600 text-white font-bold py-2 px-6 rounded-md hover:bg-green-700">Resolver Opera√ß√£o</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }).join('');
            }
            
            function renderTransactionHistory() {
                const tbody = document.getElementById('transactions-history-body');
                tbody.innerHTML = transactionHistory.length === 0
                    ? `<tr><td colspan="6" class="text-center p-4">Nenhum hist√≥rico encontrado.</td></tr>`
                    : transactionHistory.map(trans => `
                        <tr class="border-t" data-transaction-id="${trans.id}">
                            <td class="px-6 py-4">${new Date(trans.data_criacao).toLocaleDateString('pt-BR')}</td>
                            <td class="px-6 py-4">${trans.nome_conta}</td>
                            <td class="px-6 py-4">${trans.descricao}</td>
                            <td class="px-6 py-4 text-xs uppercase font-semibold">${trans.tipo.replace(/_/g, ' ')}</td>
                            <td class="px-6 py-4 font-bold ${trans.valor >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(trans.valor)}</td>
                            <td class="px-6 py-4 text-center">
                                <button title="Excluir/Reverter Transa√ß√£o" class="delete-transaction-btn text-red-500 hover:text-red-700">üóëÔ∏è</button>
                            </td>
                        </tr>`).join('');
            }
            
            function updateFinancialSummary(summary) {
                const { monthly_credits, monthly_debits, monthly_net } = summary;
                const personalBalance = allAccounts.filter(a => a.casa_de_aposta === 'pessoal').reduce((sum, acc) => sum + acc.saldo, 0);
                const bettingHousesBalance = allAccounts.filter(a => a.casa_de_aposta !== 'pessoal').reduce((sum, acc) => sum + acc.saldo, 0);
                const totalFreebets = allAccounts.reduce((sum, acc) => sum + acc.saldo_freebets, 0);
                
                document.getElementById('personal-balance').textContent = formatCurrency(personalBalance);
                document.getElementById('betting-houses-balance').textContent = formatCurrency(bettingHousesBalance);
                document.getElementById('total-freebets-balance').textContent = formatCurrency(totalFreebets);
                document.getElementById('total-balance').textContent = formatCurrency(personalBalance + bettingHousesBalance);
                
                document.getElementById('monthly-credits').textContent = formatCurrency(monthly_credits);
                document.getElementById('monthly-debits').textContent = formatCurrency(Math.abs(monthly_debits));
                
                const netElement = document.getElementById('monthly-net');
                netElement.textContent = formatCurrency(monthly_net);
                netElement.classList.remove('text-green-600', 'text-red-600', 'text-gray-800');
                if (monthly_net > 0) netElement.classList.add('text-green-600');
                else if (monthly_net < 0) netElement.classList.add('text-red-600');
                else netElement.classList.add('text-gray-800');
            }
            
            function renderReport(data) {
                const { summary, accountAnalysis } = data;
                const finalBalance = summary.netProfit + summary.totalExpenses + summary.totalPayments;
                const reportContent = document.getElementById('report-content');
                
                const summaryHtml = `
                    <div class="mb-8">
                        <h4 class="text-lg font-bold text-gray-800 mb-3">Resumo Geral do M√™s</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="bg-white shadow rounded-lg p-4">
                                <h5 class="text-sm font-semibold text-gray-500">LUCRO L√çQUIDO (APOSTAS)</h5>
                                <p class="text-2xl font-bold ${summary.netProfit >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(summary.netProfit)}</p>
                            </div>
                            <div class="bg-white shadow rounded-lg p-4">
                                <h5 class="text-sm font-semibold text-gray-500">TOTAL EM PAGAMENTOS</h5>
                                <p class="text-2xl font-bold text-red-600">${formatCurrency(Math.abs(summary.totalPayments))}</p>
                            </div>
                            <div class="bg-white shadow rounded-lg p-4">
                                <h5 class="text-sm font-semibold text-gray-500">TOTAL EM GASTOS</h5>
                                <p class="text-2xl font-bold text-rose-600">${formatCurrency(Math.abs(summary.totalExpenses))}</p>
                            </div>
                            <div class="bg-white shadow rounded-lg p-4">
                                <h5 class="text-sm font-semibold text-gray-500">BALAN√áO FINAL</h5>
                                <p class="text-2xl font-bold ${finalBalance >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(finalBalance)}</p>
                            </div>
                        </div>
                    </div>`;
                
                const accountTableHtml = accountAnalysis.length > 0 ? `
                    <div class="mb-8">
                        <h4 class="text-lg font-bold text-gray-800 mb-3">An√°lise por Conta</h4>
                        <div class="bg-white shadow rounded-lg overflow-hidden">
                            <table class="w-full text-sm">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th class="px-6 py-3 text-left">CONTA</th>
                                        <th class="px-6 py-3 text-center">N¬∫ DE APOSTAS</th>
                                        <th class="px-6 py-3 text-right">TOTAL APOSTADO</th>
                                        <th class="px-6 py-3 text-right">LUCRO / PREJU√çZO</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${accountAnalysis.sort((a, b) => b.profit - a.profit).map(acc => `
                                        <tr>
                                            <td class="px-6 py-4 text-left font-medium">${acc.name}</td>
                                            <td class="px-6 py-4 text-center">${acc.betCount}</td>
                                            <td class="px-6 py-4 text-right">${formatCurrency(acc.wagered)}</td>
                                            <td class="px-6 py-4 text-right font-bold ${acc.profit >= 0 ? 'text-green-600' : 'text-red-600'}">
                                                ${formatCurrency(acc.profit)}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>` : '';
                
                reportContent.innerHTML = summaryHtml + accountTableHtml;
            }

            // L√≥gica de eventos
            addAccountBtn.addEventListener('click', () => {
                accountForm.reset();
                document.getElementById('modal-title').textContent = 'Cadastrar Nova Conta';
                modals.account.open();
            });
            
            addTransactionBtn.addEventListener('click', () => {
                transactionForm.reset();
                document.getElementById('transaction-account').innerHTML = getAccountOptionsHtml();
                modals.transaction.open();
            });
            
            addExpenseBtn.addEventListener('click', () => {
                expenseForm.reset();
                document.getElementById('expense-account').innerHTML = allAccounts
                    .filter(a => a.casa_de_aposta === 'pessoal')
                    .map(acc => `<option value="${acc.id}">${acc.nome}</option>`)
                    .join('');
                modals.expense.open();
            });
            
            transferBtn.addEventListener('click', () => {
                transferForm.reset();
                const opts = getAccountOptionsHtml();
                document.getElementById('transfer-from').innerHTML = opts;
                document.getElementById('transfer-to').innerHTML = opts;
                modals.transfer.open();
            });
            
            backupBtn.addEventListener('click', () => {
                window.location.href = '/api/backup';
            });
            
            reportBtn.addEventListener('click', () => {
                const monthSelect = document.getElementById('report-month');
                const yearSelect = document.getElementById('report-year');
                const now = new Date();
                
                if (yearSelect.options.length === 0) {
                    for (let y = now.getFullYear(); y >= 2023; y--) {
                        yearSelect.add(new Option(y, y));
                    }
                    
                    const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                    months.forEach((m, i) => monthSelect.add(new Option(m, i + 1)));
                }
                
                yearSelect.value = now.getFullYear();
                monthSelect.value = now.getMonth() + 1;
                
                const generate = async () => {
                    document.getElementById('report-content').innerHTML = '<div class="spinner mx-auto"></div>';
                    try {
                        const data = await apiRequest(`/api/relatorio?year=${yearSelect.value}&month=${monthSelect.value}`);
                        renderReport(data);
                    } catch (error) {
                        showToast(`Erro ao gerar relat√≥rio: ${error.message}`, 'error');
                    }
                };
                
                monthSelect.onchange = generate;
                yearSelect.onchange = generate;
                generate();
                modals.report.open();
            });
            
            accountForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    const id = e.target.elements['account-id'].value;
                    const data = {
                        nome: e.target.elements['account-name'].value,
                        casaDeAposta: e.target.elements['account-provider'].value,
                        saldo: parseFloat(e.target.elements['account-balance'].value || 0),
                        saldoFreebets: parseFloat(e.target.elements['account-freebet-balance'].value || 0),
                        diaPagamento: parseInt(e.target.elements['account-payment-day'].value) || null,
                        valorPagamento: parseFloat(e.target.elements['account-payment-value'].value) || null,
                        meta: parseFloat(e.target.elements['account-goal'].value || 100),
                        volumeClube: parseFloat(e.target.elements['account-club-volume'].value || 0),
                        observacoes: e.target.elements['account-obs'].value,
                        dataUltimoCodigo: e.target.elements['account-last-code-date'].value || null,
                        ultimoPeriodoPago: id ? allAccounts.find(a => a.id == id)?.ultimo_periodo_pago : null
                    };
                    
                    if (id) {
                        await apiRequest(`/api/contas/${id}`, 'PUT', data);
                        showToast('Conta atualizada!');
                    } else {
                        await apiRequest('/api/contas', 'POST', data);
                        showToast('Conta criada!');
                    }
                    
                    modals.account.close();
                    initializeApp();
                } catch (error) {
                    showToast(`Erro ao salvar conta: ${error.message}`, 'error');
                }
            });
            
            transactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await apiRequest('/api/transacoes/generico', 'POST', {
                        accountId: e.target.elements['transaction-account'].value,
                        type: e.target.elements['transaction-type'].value,
                        amount: e.target.elements['transaction-amount'].value,
                        description: e.target.elements['transaction-description'].value
                    });
                    showToast('Lan√ßamento registrado!');
                    modals.transaction.close();
                    initializeApp();
                } catch(error) {
                    showToast(`Erro: ${error.message}`, 'error');
                }
            });
            
            expenseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await apiRequest('/api/transacoes/generico', 'POST', {
                        accountId: e.target.elements['expense-account'].value,
                        type: 'expense',
                        amount: e.target.elements['expense-amount'].value,
                        description: e.target.elements['expense-description'].value
                    });
                    showToast('Gasto registrado!');
                    modals.expense.close();
                    initializeApp();
                } catch(error) {
                    showToast(`Erro: ${error.message}`, 'error');
                }
            });
            
            transferForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fromId = e.target.elements['transfer-from'].value;
                const toId = e.target.elements['transfer-to'].value;
                
                if(fromId === toId) {
                    showToast('As contas n√£o podem ser iguais.', 'error');
                    return;
                }
                
                const toName = allAccounts.find(a => a.id == toId)?.nome || 'Outra Conta';
                
                try {
                    await apiRequest('/api/transferencia', 'POST', {
                        fromId,
                        toId,
                        amount: e.target.elements['transfer-amount'].value,
                        description: e.target.elements['transfer-description'].value || toName
                    });
                    showToast('Transfer√™ncia realizada!');
                    modals.transfer.close();
                    initializeApp();
                } catch(error) {
                    showToast(`Erro: ${error.message}`, 'error');
                }
            });
            
            operationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    const operationData = {
                        gameName: e.target.elements['operation-game-name'].value,
                        category: e.target.elements['operation-category'].value,
                        legs: Array.from(legsContainer.querySelectorAll('.leg-container')).map(leg => ({
                            result: leg.querySelector('.leg-result').value,
                            odd: leg.querySelector('.leg-odd').value,
                            accounts: Array.from(leg.querySelectorAll('.account-stake-row')).map(row => ({
                                accountId: row.querySelector('.bet-account').value,
                                stake: floorToTwoDecimals(row.querySelector('.bet-stake').value),
                                isFreebet: row.querySelector('.bet-is-freebet-checkbox')?.checked ?? false
                            }))
                        }))
                    };
                    
                    await apiRequest('/api/operacoes', 'POST', operationData);
                    showToast('Opera√ß√£o registrada!');
                    operationForm.reset();
                    legsContainer.innerHTML = '';
                    addLegRow();
                    initializeApp();
                } catch (error) {
                    showToast(`Erro: ${error.message}`, 'error');
                }
            });

            mainContainer.addEventListener('click', async (e) => {
                const target = e.target;
                
                // Pagamento de conta
                if (target.classList.contains('pay-btn')) {
                    const accountId = target.dataset.accountId;
                    const accountName = target.dataset.accountName;
                    
                    if (confirm(`Confirmar o pagamento para a conta "${accountName}" para o per√≠odo atual?`)) {
                        try {
                            await apiRequest(`/api/contas/${accountId}/pagar`, 'POST');
                            showToast('Pagamento registrado com sucesso!');
                            initializeApp();
                        } catch (err) {
                            showToast(`Erro ao registrar pagamento: ${err.message}`, 'error');
                        }
                    }
                }
                
                const accountRow = target.closest('tr[data-account-id]');
                const transactionRow = target.closest('tr[data-transaction-id]');
                
                if (accountRow) {
                    const accountId = accountRow.dataset.accountId;
                    const account = allAccounts.find(a => a.id == accountId);
                    
                    if (target.classList.contains('edit-btn')) {
                        document.getElementById('modal-title').textContent = 'Editar Conta';
                        document.getElementById('account-id').value = account.id;
                        document.getElementById('account-name').value = account.nome;
                        document.getElementById('account-provider').value = account.casa_de_aposta;
                        document.getElementById('account-balance').value = account.saldo;
                        document.getElementById('account-freebet-balance').value = account.saldo_freebets;
                        document.getElementById('account-payment-day').value = account.dia_pagamento;
                        document.getElementById('account-payment-value').value = account.valor_pagamento;
                        document.getElementById('account-goal').value = account.meta;
                        document.getElementById('account-club-volume').value = account.volume_clube;
                        document.getElementById('account-obs').value = account.observacoes;
                        document.getElementById('account-last-code-date').value = account.data_ultimo_codigo;
                        modals.account.open();
                    }
                    
                    if (target.classList.contains('delete-btn')) {
                        if (confirm(`Desativar a conta "${account.nome}"?`)) {
                            try {
                                await apiRequest(`/api/contas/${accountId}`, 'DELETE');
                                showToast('Conta desativada!');
                                initializeApp();
                            } catch (err) {
                                showToast(`Erro: ${err.message}`, 'error');
                            }
                        }
                    }
                }
                
                if (transactionRow && target.classList.contains('delete-transaction-btn')) {
                    if (confirm('Excluir e reverter esta transa√ß√£o? A a√ß√£o n√£o pode ser desfeita.')) {
                        try {
                            await apiRequest(`/api/transacoes/${transactionRow.dataset.transactionId}`, 'DELETE');
                            showToast('Transa√ß√£o revertida!');
                            initializeApp();
                        } catch (err) {
                            showToast(`Erro ao reverter: ${err.message}`, 'error');
                        }
                    }
                }
                
                if (target.closest('.toggle-details-btn')) {
                    target.closest('.operation-card').classList.toggle('is-expanded');
                }
                
                if (target.classList.contains('resolve-operation-btn')) {
                    const card = target.closest('.operation-card');
                    const operationId = card.dataset.opId;
                    const winnerRadio = card.querySelector('.market-winner-radio:checked');
                    const isLost = card.querySelector('.lost-operation-checkbox:checked');
                    
                    if (winnerRadio && isLost) {
                        return showToast('N√£o √© poss√≠vel marcar um vencedor E a opera√ß√£o como perdida.', 'error');
                    }
                    
                    if (!winnerRadio && !isLost) {
                        return showToast('Selecione um resultado vencedor OU marque a opera√ß√£o como perdida.', 'error');
                    }
                    
                    const winningMarket = isLost ? null : winnerRadio.value;
                    
                    try {
                        await apiRequest('/api/operacoes/resolver', 'POST', { operationId, winningMarket });
                        showToast('Opera√ß√£o resolvida com sucesso!');
                        initializeApp();
                    } catch (err) {
                        showToast(`Erro ao resolver: ${err.message}`, 'error');
                    }
                }
            });

            function updateLegSummary(legContainer) {
                if (!legContainer) return;
                
                let totalStake = 0;
                let totalPotentialReturn = 0;
                const odd = parseFloat(legContainer.querySelector('.leg-odd').value) || 0;
                const accountRows = legContainer.querySelectorAll('.account-stake-row');
                
                accountRows.forEach(row => {
                    const stake = parseFloat(row.querySelector('.bet-stake').value) || 0;
                    const isFreebet = row.querySelector('.bet-is-freebet-checkbox').checked;
                    totalStake += stake;
                    
                    if (isFreebet) {
                        totalPotentialReturn += stake * (odd > 1 ? odd - 1 : 0);
                    } else {
                        totalPotentialReturn += stake * odd;
                    }
                });
                
                const summaryEl = legContainer.querySelector('.leg-summary');
                if (totalStake > 0) {
                    summaryEl.innerHTML = `Total Apostado: <span class="text-red-600">${formatCurrency(totalStake)}</span> | Retorno Poss√≠vel: <span class="text-green-600">${formatCurrency(totalPotentialReturn)}</span>`;
                } else {
                    summaryEl.innerHTML = '';
                }
            }

            function getAccountOptionsHtml() {
                return allAccounts.map(acc => `<option value="${acc.id}">${acc.nome} (${formatCurrency(acc.saldo)})</option>`).join('');
            }
            
            function addAccountStakeRow() {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2 mt-2 account-stake-row';
                row.innerHTML = `
                    <select class="bet-account block w-full rounded-md border-gray-300 text-sm">${getAccountOptionsHtml()}</select>
                    <input type="number" step="0.01" class="bet-stake block w-40 rounded-md border-gray-300 text-sm" placeholder="Valor (R$)" required>
                    <label class="flex items-center text-xs whitespace-nowrap">
                        <input type="checkbox" class="bet-is-freebet-checkbox h-4 w-4 mr-1"> Usar FB?
                    </label>
                    <button type="button" class="remove-account-stake-btn text-red-500 font-bold ml-auto">X</button>`;
                return row;
            }

            function addLegRow() {
                const legWrapper = document.createElement('div');
                legWrapper.className = 'p-4 border rounded-lg bg-gray-50 leg-container';
                legWrapper.innerHTML = `
                    <div class="relative grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs">Resultado / Mercado</label>
                            <input type="text" class="leg-result mt-1 block w-full rounded-md border-gray-300" required>
                        </div>
                        <div class="flex items-end gap-3">
                            <div class="flex-grow">
                                <label class="block text-xs">Odd</label>
                                <input type="number" step="0.0001" class="leg-odd mt-1 block w-full rounded-md border-gray-300" required>
                            </div>
                            <label class="flex items-center pb-1 whitespace-nowrap text-sm">
                                <input type="checkbox" class="same-value-checkbox h-4 w-4 mr-1"> Mesmo Valor?
                            </label>
                        </div>
                        <button type="button" class="remove-leg-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center font-bold text-sm">‚úï</button>
                    </div>
                    <div class="mt-4 border-t pt-4">
                        <div class="accounts-stakes-container space-y-2"></div>
                        <button type="button" class="add-account-stake-btn mt-2 text-sm text-blue-600 hover:underline">+ Adicionar Conta</button>
                        <div class="leg-summary mt-3 text-sm font-bold text-right"></div>
                    </div>`;
                
                legWrapper.querySelector('.accounts-stakes-container').appendChild(addAccountStakeRow());
                legsContainer.appendChild(legWrapper);
                updateLegSummary(legWrapper);
            }

            addLegBtn.addEventListener('click', addLegRow);

            legsContainer.addEventListener('input', e => {
                const legContainer = e.target.closest('.leg-container');
                if (!legContainer) return;
                
                if (e.target.classList.contains('bet-stake')) {
                    const isSameValue = legContainer.querySelector('.same-value-checkbox').checked;
                    if (isSameValue) {
                        const sourceValue = e.target.value;
                        legContainer.querySelectorAll('.bet-stake').forEach(input => {
                            if (input !== e.target) { input.value = sourceValue; }
                        });
                    }
                }
                updateLegSummary(legContainer);
            });

            legsContainer.addEventListener('change', e => {
                const legContainer = e.target.closest('.leg-container');
                if (!legContainer) return;
                
                if (e.target.classList.contains('bet-is-freebet-checkbox') || e.target.classList.contains('same-value-checkbox')) {
                    if (e.target.classList.contains('same-value-checkbox') && e.target.checked) {
                        const firstStake = legContainer.querySelector('.bet-stake')?.value || '';
                        legContainer.querySelectorAll('.bet-stake').forEach(input => input.value = firstStake);
                    }
                    updateLegSummary(legContainer);
                }
            });

            legsContainer.addEventListener('click', e => {
                const legContainer = e.target.closest('.leg-container');
                if (!legContainer) return;
                
                if (e.target.classList.contains('remove-leg-btn')) {
                    legContainer.remove();
                } else if (e.target.classList.contains('add-account-stake-btn')) {
                    const container = legContainer.querySelector('.accounts-stakes-container');
                    const newRow = addAccountStakeRow();
                    const isSameValue = legContainer.querySelector('.same-value-checkbox').checked;
                    
                    if (isSameValue) {
                        const firstStakeValue = legContainer.querySelector('.bet-stake')?.value || '';
                        newRow.querySelector('.bet-stake').value = firstStakeValue;
                    }
                    
                    container.appendChild(newRow);
                    updateLegSummary(legContainer);
                } else if (e.target.classList.contains('remove-account-stake-btn')) {
                    e.target.closest('.account-stake-row').remove();
                    updateLegSummary(legContainer);
                }
            });

            mainTabsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-btn')) {
                    const tabId = e.target.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(`tab-content-${tabId}`).classList.add('active');
                }
            });
            
            operationCategorySelect.addEventListener('change', () => {
                const isCasino = operationCategorySelect.value === 'cassino';
                document.getElementById('multi-bet-container').classList.toggle('hidden', isCasino);
                document.getElementById('cassino-container').classList.toggle('hidden', !isCasino);
                
                document.querySelectorAll('#multi-bet-container [required]').forEach(el => el.required = !isCasino);
                document.querySelectorAll('#cassino-container [required]').forEach(el => el.required = isCasino);
            });

            // Ferramentas de dados
            const restoreFileInput = document.getElementById('restore-file-input');
            const restoreBtn = document.getElementById('restore-btn');
            const csvFileInput = document.getElementById('csv-file-input');
            const importCsvBtn = document.getElementById('import-csv-btn');
            const downloadTemplateBtn = document.getElementById('download-template-btn');

            restoreFileInput.addEventListener('change', () => {
                restoreBtn.disabled = !restoreFileInput.files.length;
            });

            csvFileInput.addEventListener('change', () => {
                importCsvBtn.disabled = !csvFileInput.files.length;
            });

            restoreBtn.addEventListener('click', async () => {
                if (!restoreFileInput.files.length) {
                    return showToast('Por favor, selecione um arquivo de backup.', 'error');
                }
                
                if (!confirm('ATEN√á√ÉO!\n\nEsta a√ß√£o ir√° apagar TODOS os seus dados atuais e substitu√≠-los pelos dados do backup.\n\nEsta a√ß√£o n√£o pode ser desfeita. Deseja continuar?')) {
                    return;
                }

                const file = restoreFileInput.files[0];
                const formData = new FormData();
                formData.append('backupFile', file);

                try {
                    restoreBtn.innerHTML = '<div class="spinner mx-auto"></div>';
                    restoreBtn.disabled = true;

                    const response = await fetch('/api/restore', { method: 'POST', body: formData });
                    const result = await response.json();

                    if (!response.ok) throw new Error(result.error);

                    showToast(result.message, 'success');
                    initializeApp();
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    restoreFileInput.value = ''; 
                    restoreBtn.innerHTML = 'Restaurar Dados';
                    restoreBtn.disabled = true;
                }
            });

            importCsvBtn.addEventListener('click', async () => {
                if (!csvFileInput.files.length) {
                    return showToast('Por favor, selecione um arquivo CSV.', 'error');
                }

                const file = csvFileInput.files[0];
                const formData = new FormData();
                formData.append('csvFile', file);

                try {
                    importCsvBtn.innerHTML = '<div class="spinner mx-auto"></div>';
                    importCsvBtn.disabled = true;
                    
                    const response = await fetch('/api/import-csv', { method: 'POST', body: formData });
                    const result = await response.json();

                    if (!response.ok) throw new Error(result.error);
                    
                    showToast(result.message, 'success');
                    initializeApp();
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    csvFileInput.value = '';
                    importCsvBtn.innerHTML = 'Importar CSV';
                    importCsvBtn.disabled = true;
                }
            });

            downloadTemplateBtn.addEventListener('click', () => {
                window.location.href = '/api/csv-template';
            });

            async function initializeApp() {
                try {
                    const data = await apiRequest('/api/dados-iniciais');
                    allAccounts = data.contas;
                    activeOperations = data.operacoesAtivas;
                    transactionHistory = data.historico;
                    
                    renderTables();
                    renderActiveOperations();
                    renderTransactionHistory();
                    updateFinancialSummary(data.resumoFinanceiro);
                    
                    if (legsContainer.children.length === 0) {
                        addLegRow();
                    } else {
                        legsContainer.querySelectorAll('.bet-account').forEach(select => {
                            const sel = select.value;
                            select.innerHTML = getAccountOptionsHtml();
                            select.value = sel;
                        });
                        legsContainer.querySelectorAll('.leg-container').forEach(leg => updateLegSummary(leg));
                    }
                    
                    operationCategorySelect.dispatchEvent(new Event('change'));
                } catch (error) {
                    showToast(`Erro fatal ao carregar: ${error.message}`, 'error');
                }
            }
            
            // Inicializar a aplica√ß√£o
            initializeApp();
        });
    </script>
</body>
</html>
